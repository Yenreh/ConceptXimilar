<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Demo Ximilar API - Plan Gratuito</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé® Demo Ximilar API</h1>
            <p>Principales servicios disponibles en el plan gratuito</p>
        </div>

        <div class="main-card">
            <div class="tab-bar">
                <button class="tab-btn active" onclick="showTab('removebg')">Background Removal</button>
                <button class="tab-btn" onclick="showTab('colors')">Dominant Colors</button>
                <button class="tab-btn" onclick="showTab('tagging')">Photo Tagging</button>
            </div>

            <!-- BACKGROUND REMOVAL TAB -->
            <div id="tab-removebg" class="tab-content" style="display:block;">
                <div class="removebg-section">
                    <h2 class="section-title">Eliminaci√≥n de Fondo</h2>
                    
                    <div class="controls">
                        <input type="file" id="removebgFile" accept="image/*" class="styled-input">
                        <select id="removebgModel" class="styled-input" style="max-width: 250px;">
                            <option value="precise">Modelo Preciso (alta calidad)</option>
                            <option value="fast">Modelo R√°pido (menor costo)</option>
                        </select>
                        <button class="btn btn-start" onclick="removeBgFile()">üóëÔ∏è Eliminar Fondo</button>
                    </div>
                    
                    <div id="removebgLoading" class="loading">
                        <div class="spinner"></div>
                        <p>Procesando imagen...</p>
                    </div>
                    
                    <div id="removebgResult" class="result-images"></div>
                </div>
            </div>

            <!-- DOMINANT COLORS TAB -->
            <div id="tab-colors" class="tab-content" style="display:none;">
                <div class="colors-section">
                    <h2 class="section-title">Colores Dominantes</h2>
                    
                    <div class="controls">
                        <input type="file" id="colorsFile" accept="image/*" class="styled-input">
                        <label style="color: #9ca3af;">N√∫mero m√°ximo de colores:</label>
                        <input type="number" id="maxColors" value="5" min="1" max="10" class="styled-input" style="width: 80px;">
                        <button class="btn btn-start" onclick="analyzeColorsFile()">üé® Extraer Colores</button>
                    </div>
                    
                    <div id="colorsLoading" class="loading">
                        <div class="spinner"></div>
                        <p>Extrayendo colores...</p>
                    </div>
                    
                    <div id="colorsResult" class="color-palette"></div>
                    <div id="colorsImage" class="image-preview"></div>
                </div>
            </div>

            <!-- PHOTO TAGGING TAB -->
            <div id="tab-tagging" class="tab-content" style="display:none;">
                <div class="tagging-section">
                    <h2 class="section-title">Etiquetado de Fotos</h2>
                    
                    <div class="controls">
                        <input type="file" id="taggingFile" accept="image/*" class="styled-input">
                        <button class="btn btn-start" onclick="tagPhotoFile()">üè∑Ô∏è Etiquetar Foto</button>
                    </div>
                    
                    <div id="taggingLoading" class="loading">
                        <div class="spinner"></div>
                        <p>Analizando imagen...</p>
                    </div>
                    
                    <div id="taggingResult" class="result-box"></div>
                    <div id="taggingImage" class="image-preview"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function showTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tabDiv => tabDiv.style.display = 'none');
            document.querySelector('.tab-btn[onclick*="' + tab + '"]').classList.add('active');
            document.getElementById('tab-' + tab).style.display = 'block';
        }

        // Background Removal Functions
        async function removeBgFile() {
            const fileInput = document.getElementById('removebgFile');
            if (!fileInput.files.length) {
                alert('Por favor seleccione un archivo de imagen');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('model', document.getElementById('removebgModel').value);
            
            document.getElementById('removebgLoading').style.display = 'block';
            document.getElementById('removebgResult').innerHTML = '';
            
            const response = await fetch('/removebg/upload', {
                method: 'POST',
                body: formData
            });
            
            document.getElementById('removebgLoading').style.display = 'none';
            const data = await response.json();
            displayRemoveBgResults(data);
        }

        function displayRemoveBgResults(data) {
            const resultDiv = document.getElementById('removebgResult');
            
            if (data.error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                return;
            }
            
            if (!data.records || !data.records.length) {
                resultDiv.innerHTML = '<div class="error">No se encontraron resultados</div>';
                return;
            }
            
            const record = data.records[0];
            let html = '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">';
            
            if (record._output_url) {
                html += `
                    <div style="background: rgba(31, 41, 55, 0.5); padding: 15px; border-radius: 10px;">
                        <h4 style="color: #a5b4fc; margin-bottom: 10px;">üñºÔ∏è Fondo Transparente</h4>
                        <img src="${record._output_url}" style="width: 100%; border-radius: 8px; background: repeating-conic-gradient(#808080 0% 25%, transparent 0% 50%) 50% / 20px 20px;">
                        <a href="${record._output_url}" download class="btn btn-start" style="margin-top: 10px; justify-content: center;">‚¨áÔ∏è Descargar</a>
                    </div>
                `;
            }
            
            html += '</div>';
            
            if (data.statistics && data.statistics['processing time']) {
                html += `<p style="color: #9ca3af; margin-top: 15px; text-align: center; font-size: 0.9em;">‚è±Ô∏è Tiempo de procesamiento: ${data.statistics['processing time'].toFixed(2)}s</p>`;
            }
            
            resultDiv.innerHTML = html;
        }

        // Dominant Colors Functions
        async function analyzeColorsFile() {
            const fileInput = document.getElementById('colorsFile');
            if (!fileInput.files.length) {
                alert('Por favor seleccione un archivo de imagen');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            formData.append('max_colors', document.getElementById('maxColors').value);
            
            document.getElementById('colorsLoading').style.display = 'block';
            document.getElementById('colorsResult').innerHTML = '';
            document.getElementById('colorsImage').innerHTML = '';
            
            const response = await fetch('/colors/upload', {
                method: 'POST',
                body: formData
            });
            
            document.getElementById('colorsLoading').style.display = 'none';
            const data = await response.json();
            displayColorsResults(data);
        }

        function displayColorsResults(data, imageUrl) {
            const resultDiv = document.getElementById('colorsResult');
            const imageDiv = document.getElementById('colorsImage');
            
            if (data.error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                return;
            }
            
            if (!data.records || !data.records.length) {
                resultDiv.innerHTML = '<div class="error">No se encontraron resultados</div>';
                return;
            }
            
            const record = data.records[0];
            
            if (imageUrl) {
                imageDiv.innerHTML = `<img src="${imageUrl}" style="max-width: 100%; border-radius: 10px; margin-bottom: 20px;">`;
            }
            
            let html = '<div style="margin-top: 20px;">';
            
            // La estructura real de la API es _dominant_colors.rgb_colors
            if (record._dominant_colors && record._dominant_colors.rgb_colors) {
                const colors = record._dominant_colors;
                html += '<h3 style="color: #a5b4fc; margin-bottom: 15px;">üé® Colores Dominantes:</h3>';
                html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px;">';
                
                colors.rgb_colors.forEach((rgb, idx) => {
                    const rgbStr = `rgb(${rgb[0]}, ${rgb[1]}, ${rgb[2]})`;
                    const hexColor = colors.rgb_hex_colors[idx] || '';
                    const colorName = colors.color_names_pantone ? colors.color_names_pantone[idx] : colors.color_names[idx];
                    const percentage = colors.percentages[idx] || 0;
                    
                    html += `
                        <div style="background: rgba(31, 41, 55, 0.5); padding: 15px; border-radius: 10px; text-align: center;">
                            <div style="width: 100%; height: 80px; background: ${rgbStr}; border-radius: 8px; margin-bottom: 10px; border: 2px solid rgba(255,255,255,0.1);"></div>
                            <p style="color: #e5e7eb; font-weight: 600; margin-bottom: 5px;">${colorName || 'Color'}</p>
                            <p style="color: #9ca3af; font-size: 0.85em;">${hexColor}</p>
                            <p style="color: #9ca3af; font-size: 0.85em;">RGB(${rgb[0]}, ${rgb[1]}, ${rgb[2]})</p>
                            <p style="color: #9ca3af; font-size: 0.85em;">${(percentage * 100).toFixed(1)}% cobertura</p>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        // Photo Tagging Functions
        async function tagPhotoFile() {
            const fileInput = document.getElementById('taggingFile');
            if (!fileInput.files.length) {
                alert('Por favor seleccione un archivo de imagen');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            
            document.getElementById('taggingLoading').style.display = 'block';
            document.getElementById('taggingResult').innerHTML = '';
            document.getElementById('taggingImage').innerHTML = '';
            
            const response = await fetch('/tagging/upload', {
                method: 'POST',
                body: formData
            });
            
            document.getElementById('taggingLoading').style.display = 'none';
            const data = await response.json();
            displayTaggingResults(data);
        }

        function displayTaggingResults(data) {
            const resultDiv = document.getElementById('taggingResult');
            const imageDiv = document.getElementById('taggingImage');
            
            if (data.error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                return;
            }
            
            if (!data.records || !data.records.length) {
                resultDiv.innerHTML = '<div class="error">No se encontraron resultados</div>';
                return;
            }
            
            const record = data.records[0];
            
            let html = '<div style="margin-top: 20px;">';
            
            if (record._tags && record._tags.length > 0) {
                html += '<h3 style="color: #a5b4fc; margin-bottom: 15px;">üè∑Ô∏è Etiquetas Detectadas:</h3>';
                html += '<div style="display: flex; flex-wrap: wrap; gap: 10px;">';
                
                record._tags.forEach(tag => {
                    const confidence = tag.prob || tag.confidence || 0;
                    html += `
                        <span style="background: rgba(99, 102, 241, 0.2); color: #a5b4fc; padding: 8px 16px; border-radius: 20px; border: 1px solid rgba(99, 102, 241, 0.3);">
                            ${tag.name || tag.label || tag} 
                            <span style="color: #9ca3af; font-size: 0.85em;">(${(confidence * 100).toFixed(1)}%)</span>
                        </span>
                    `;
                });
                
                html += '</div>';
            } else {
                html += '<p style="color: #9ca3af;">No se detectaron etiquetas en la imagen.</p>';
            }
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        // Object Detection Functions
        async function detectObjectsFile() {
            const fileInput = document.getElementById('detectionFile');
            if (!fileInput.files.length) {
                alert('Por favor seleccione un archivo de imagen');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            
            const taskId = document.getElementById('taskId').value.trim();
            if (taskId) {
                formData.append('task_id', taskId);
            }
            
            document.getElementById('detectionLoading').style.display = 'block';
            document.getElementById('detectionResult').innerHTML = '';
            document.getElementById('detectionImage').innerHTML = '';
            
            const response = await fetch('/detection/upload', {
                method: 'POST',
                body: formData
            });
            
            document.getElementById('detectionLoading').style.display = 'none';
            const data = await response.json();
            displayDetectionResults(data);
        }

        function displayDetectionResults(data) {
            const resultDiv = document.getElementById('detectionResult');
            const imageDiv = document.getElementById('detectionImage');
            
            if (data.error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                return;
            }
            
            if (!data.records || !data.records.length) {
                resultDiv.innerHTML = '<div class="error">No se encontraron resultados</div>';
                return;
            }
            
            const record = data.records[0];
            
            let html = '<div style="margin-top: 20px;">';
            
            if (record._objects && record._objects.length > 0) {
                html += '<h3 style="color: #a5b4fc; margin-bottom: 15px;">üîç Objetos Detectados:</h3>';
                
                record._objects.forEach((obj, idx) => {
                    html += `
                        <div style="background: rgba(31, 41, 55, 0.5); padding: 15px; margin-bottom: 15px; border-radius: 10px; border-left: 4px solid #6366f1;">
                            <h4 style="color: #c4b5fd; margin-bottom: 10px;">Objeto ${idx + 1}: ${obj.name || 'Desconocido'}</h4>
                            <p style="color: #9ca3af;">Confianza: <span style="color: #a5b4fc; font-weight: 600;">${(obj.prob * 100).toFixed(1)}%</span></p>
                    `;
                    
                    if (obj.bound_box && obj.bound_box.length === 4) {
                        html += `<p style="color: #9ca3af; font-size: 0.9em;">üìç Posici√≥n: [${obj.bound_box.map(v => v.toFixed(2)).join(', ')}]</p>`;
                    }
                    
                    html += '</div>';
                });
            } else {
                html += '<p style="color: #9ca3af;">No se detectaron objetos en la imagen.</p>';
            }
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }

        // Object Detection Functions
        async function detectObjectsFile() {
            const fileInput = document.getElementById('detectionFile');
            if (!fileInput.files.length) {
                alert('Por favor seleccione un archivo de imagen');
                return;
            }
            
            const formData = new FormData();
            formData.append('image', fileInput.files[0]);
            
            const taskId = document.getElementById('taskId').value.trim();
            if (taskId) {
                formData.append('task_id', taskId);
            }
            
            document.getElementById('detectionLoading').style.display = 'block';
            document.getElementById('detectionResult').innerHTML = '';
            document.getElementById('detectionImage').innerHTML = '';
            
            const response = await fetch('/detection/upload', {
                method: 'POST',
                body: formData
            });
            
            document.getElementById('detectionLoading').style.display = 'none';
            const data = await response.json();
            displayDetectionResults(data);
        }

        function displayDetectionResults(data) {
            const resultDiv = document.getElementById('detectionResult');
            const imageDiv = document.getElementById('detectionImage');
            
            if (data.error) {
                resultDiv.innerHTML = `<div class="error">‚ùå Error: ${data.error}</div>`;
                return;
            }
            
            if (!data.records || !data.records.length) {
                resultDiv.innerHTML = '<div class="error">No se encontraron resultados</div>';
                return;
            }
            
            const record = data.records[0];
            
            let html = '<div style="margin-top: 20px;">';
            
            if (record._objects && record._objects.length > 0) {
                html += '<h3 style="color: #a5b4fc; margin-bottom: 15px;">üîç Objetos Detectados:</h3>';
                
                record._objects.forEach((obj, idx) => {
                    html += `
                        <div style="background: rgba(31, 41, 55, 0.5); padding: 15px; margin-bottom: 15px; border-radius: 10px; border-left: 4px solid #6366f1;">
                            <h4 style="color: #c4b5fd; margin-bottom: 10px;">Objeto ${idx + 1}: ${obj.name || 'Desconocido'}</h4>
                            <p style="color: #9ca3af;">Confianza: <span style="color: #a5b4fc; font-weight: 600;">${(obj.prob * 100).toFixed(1)}%</span></p>
                    `;
                    
                    if (obj.bound_box && obj.bound_box.length === 4) {
                        html += `<p style="color: #9ca3af; font-size: 0.9em;">üìç Posici√≥n: [${obj.bound_box.map(v => v.toFixed(2)).join(', ')}]</p>`;
                    }
                    
                    html += '</div>';
                });
            } else {
                html += '<p style="color: #9ca3af;">No se detectaron objetos en la imagen.</p>';
            }
            
            html += '</div>';
            resultDiv.innerHTML = html;
        }
    </script>
</body>
</html>
